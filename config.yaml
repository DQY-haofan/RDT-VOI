# =====================================================================
# RDT Sensor Optimization - 修复后的配置
# =====================================================================
# 主要修改：
# 1. 量纲匹配：μ=2.2, σ=0.55, τ=2.0（让τ在μ±2σ范围内）
# 2. 冗余增强：pool_fraction=0.75, footprint=avg3x3（增加重叠）
# 3. 相关缩短：kappa=0.10（相关长度≈28m）
# 4. EVI方法：改用monte_carlo（使用修复后的算法）

experiment:
  name: rdt_sensor_optimization_v1
  output_dir: runs
  seed: 202501

# ---------------------------------------------------------------------
# 数值计算参数
# ---------------------------------------------------------------------
numerics:
  linear_solver_tol: 1.0e-08
  cholesky_nugget: 1.0e-09
  logdet_method: cholesky
  pcg_max_iter: 1000

# ---------------------------------------------------------------------
# 空间几何配置
# ---------------------------------------------------------------------
geometry:
  mode: grid2d
  nx: 40
  ny: 40
  h: 5.0  # 网格间距5m

# ---------------------------------------------------------------------
# 先验分布参数（Matérn GMRF）
# 🔧 修改：量纲匹配 + 缩短相关长度
# ---------------------------------------------------------------------
prior:
  nu: 1.0              # 平滑度参数
  kappa: 0.10          # 🔧 0.08→0.10（相关长度≈28m，原35m）
  sigma2: 0.30         # 🔧 0.04→0.30（σ≈0.55，原0.2）
  alpha: 2             # SPDE阶数
  beta: 1.0e-06        # 正定化nugget
  mu_prior_mean: 2.2   # 🔧 1.5→2.2（提高均值，让τ=2.0在分布中）
  mu_prior_std: 0.0    # 常数均值场

# ---------------------------------------------------------------------
# 传感器配置
# 🔧 修改：增加密度 + 重叠足迹
# ---------------------------------------------------------------------
sensors:
  pool_fraction: 0.75           # 🔧 0.25→0.75（3倍密度）
  pool_strategy: grid_subsample # 保持规则采样
  type_mix:
    - 0.4  # inertial_profiler
    - 0.4  # photogrammetry
    - 0.2  # smartphone

  types:
    # 高精度惯性轮廓仪
    - name: inertial_profiler
      noise_std: 0.1
      cost_gbp: 10000.0
      footprint: avg3x3  # 🔧 point→avg3x3（产生重叠）

    # 中等精度摄影测量
    - name: photogrammetry
      noise_std: 0.25
      cost_gbp: 5000.0
      footprint: avg3x3  # 保持

    # 低成本智能手机
    - name: smartphone
      noise_std: 0.5
      cost_gbp: 500.0
      footprint: avg5x5  # 保持（大核）

# ---------------------------------------------------------------------
# 决策模型参数
# 🔧 修改：阈值降低到分布范围内
# ---------------------------------------------------------------------
decision:
  tau_iri: 2.0        # 🔧 2.7→2.0（让τ∈[μ-2σ,μ+2σ]）
  L_TP_gbp: 5000.0    # 正确维护成本
  L_FP_gbp: 8000.0    # 误报成本
  L_FN_gbp: 40000.0   # 漏报成本（严重）
  L_TN_gbp: 0.0       # 正确不维护

# ---------------------------------------------------------------------
# 传感器选择算法
# ---------------------------------------------------------------------
selection:
  methods:
    - greedy_mi
    - greedy_aopt
    - uniform
    - random

  budgets:
    - 5
    - 10
    - 20
    - 40
    - 60
    - 80

  greedy_mi:
    lazy: true
    cost_normalized: true    # ✅ 保持（启用成本约束）
    warmstart_enum: false

  greedy_aopt:
    lazy: true
    trace_estimator: hutchpp
    hutchpp_probes: 20

# ---------------------------------------------------------------------
# EVI计算配置
# 🔧 修改：改用修复后的monte_carlo方法
# ---------------------------------------------------------------------
evi:
  compute_for:
    - greedy_mi
  method: monte_carlo        # 🔧 unscented→monte_carlo
  monte_carlo_samples: 1000  # 🔧 500→1000（提高精度）
  unscented_alpha: 1.0       # 保留（如需切换回UT）
  unscented_beta: 2.0
  unscented_kappa: 0.0

# ---------------------------------------------------------------------
# 空间交叉验证
# ---------------------------------------------------------------------
cv:
  scheme: spatial_block
  k_folds: 5
  buffer_width_multiplier: 1.5
  block_strategy: kmeans
  ensure_connected: true

# ---------------------------------------------------------------------
# 不确定性量化
# ---------------------------------------------------------------------
uq:
  bootstrap_method: spatial_block
  bootstrap_samples: 1000
  confidence_level: 0.95
  coverage_percentile: 90
  compute_crps: false

# ---------------------------------------------------------------------
# 诊断指标
# ---------------------------------------------------------------------
diagnostics:
  morans_i:
    permutations: 999
    weight_type: adjacency
  calibration:
    compute_coverage: true
    compute_msse: true

# ---------------------------------------------------------------------
# 可视化配置
# ---------------------------------------------------------------------
plots:
  save_formats:
    - png
    - pdf
  dpi: 300
  style: seaborn-v0_8-paper

  budget_curves:
    show_ci: true
    metrics:
      - expected_loss
      - rmse
      - mae

  performance_profile:
    tau_max: 3.0

  critical_difference:
    alpha: 0.05
    test: nemenyi

# ---------------------------------------------------------------------
# 日志配置
# ---------------------------------------------------------------------
logging:
  level: INFO
  console: true
  file: true
  jsonl_metrics: true

# ---------------------------------------------------------------------
# 验收标准
# ---------------------------------------------------------------------
acceptance:
  # M1: 小规模验证
  m1_grid_size: 1600
  m1_budgets: [10, 20, 40]
  m1_check_monotonic: true
  m1_check_diminishing: true

  # M2: 基线比较
  m2_min_improvement_vs_random: 0.15
  m2_confidence_level: 0.95

  # M3: 近似比验证
  m3_small_instance_n: 200
  m3_small_instance_k: 8
  m3_max_suboptimality: 1.58

  # M4: 空间诊断
  m4_morans_alpha: 0.05
  m4_coverage_tolerance: 0.05
  m4_msse_tolerance: 0.2