# ============================================================================
# RDT-VoI ä¿®å¤åçš„åŸºå‡†é…ç½® âœ…
#
# æœ¬é…ç½®æ•´åˆäº†ä¸“å®¶å®¡æŸ¥çš„æ‰€æœ‰P0ã€P1ã€P2ä¿®å¤
#
# å…³é”®ä¿®æ”¹ï¼š
#   P0-3: tau_quantile = nullï¼ˆç¦ç”¨åˆ†ä½æ•°å…œåº•ï¼Œä½¿ç”¨é”å®šé˜ˆå€¼ï¼‰
#   P1-4: æ·»åŠ  economics éƒ¨åˆ†ï¼ˆç»æµå°ºåº¦æ ¡å‡†ï¼‰
#   P1-6: keep_fraction = 0.15ï¼ˆæ›´è‹›åˆ»çš„é¢„ç­›ï¼‰
#   P2: pool_fraction = 0.20ï¼ˆç¨€ç–å€™é€‰æ± ï¼‰
#
# é¢„æœŸæ•ˆæœï¼š
#   âœ… ROI(k=5) > 0
#   âœ… Î”(EVI-MI) @ k=3 â‰ˆ 10-15%
#   âœ… Action-limited æŒ‡æ ‡åˆ†åŒ–
#   âœ… savings_near_threshold > 0
# ============================================================================

experiment:
  name: "rdt_voi_expert_fixes"
  seed: 42
  output_dir: "results/"

# ----------------------------------------------------------------------------
# Numerical Settings
# ----------------------------------------------------------------------------
numerics:
  linear_solver_tol: 1.0e-8
  cholesky_nugget: 1.0e-6
  pcg_max_iter: 500
  logdet_method: "cholmod"

# ----------------------------------------------------------------------------
# Spatial Domain
# ----------------------------------------------------------------------------
geometry:
  mode: "grid2d"
  nx: 20
  ny: 20
  h: 5.0

# ----------------------------------------------------------------------------
# ğŸ”¥ Prior Distribution - å¢å¼ºç©ºé—´å¼‚è´¨æ€§
# ----------------------------------------------------------------------------
prior:
  # SPDE å‚æ•°
  nu: 1.0
  kappa: 0.10
  sigma2: 0.25

  # ğŸ”¥ Nuggetï¼ˆåˆ›å»ºæ–¹å·®å¼‚è´¨æ€§ï¼‰
  alpha: 1.0e-2          # ç©ºé—´å¹³æ»‘
  beta: 1.0e-3           # å‘åå…¼å®¹
  beta_base: 0.15      # âœ… ä¿®å¤ï¼šä¸betaä¸€è‡´ï¼ˆéçƒ­ç‚¹ï¼‰
  beta_hot: 1.0e-5       # çƒ­ç‚¹åŒºåŸŸï¼ˆé«˜æ–¹å·®ï¼‰

  # å‡å€¼åœº
  mu_prior_mean: 2.2
  mu_prior_std: 0.3

  # çƒ­ç‚¹é…ç½®
  hotspots:
    - center: [25.0, 75.0]
      radius: 20.0
    - center: [75.0, 25.0]
      radius: 20.0
    - center: [50.0, 50.0]
      radius: 20.0
    - center: [25.0, 25.0]  # â† æ–°å¢
      radius: 15.0
    - center: [75.0, 75.0]  # â† æ–°å¢
      radius: 15.0

# ----------------------------------------------------------------------------
# ğŸ”¥ Sensor Pool - é™å™ª + ç¨€ç– + æˆæœ¬æ¢¯åº¦
# ----------------------------------------------------------------------------
sensors:
  types:
    # æ‰€æœ‰å™ªå£° Ã—0.7ï¼Œæˆæœ¬æ‹‰å¼€æ¢¯åº¦
    - name: "smartphone"
      noise_std: 0.35      # 0.50 Ã— 0.7
      cost_gbp: 30
      footprint: point

    - name: "basic_point"
      noise_std: 0.084     # 0.12 Ã— 0.7
      cost_gbp: 150
      footprint: "point"

    - name: "laser_profiler"
      noise_std: 0.025     # 0.035 Ã— 0.7
      cost_gbp: 300
      footprint: "point"

    - name: photogrammetry
      noise_std: 0.14      # 0.20 Ã— 0.7
      cost_gbp: 200
      footprint: avg3x3

    - name: "vehicle_avg"
      noise_std: 0.21      # 0.30 Ã— 0.7
      cost_gbp: 250
      footprint: "avg5x5"

    - name: inertial_profiler
      noise_std: 0.084     # 0.12 Ã— 0.7
      cost_gbp: 400
      footprint: avg3x3

  # ğŸ”¥ P2ï¼šç¨€ç–å€™é€‰æ± ï¼ˆæé«˜é€‰æ‹©éš¾åº¦ï¼‰
  pool_strategy: "grid_subsample"
  pool_fraction: 0.20      # âœ… ä»0.30é™è‡³0.20
  type_mix: [0.15, 0.20, 0.10, 0.20, 0.15, 0.20]

  use_heterogeneous: true
  cost_zones:
    - center_m: [100, 100]
      radius_m: 50
      cost_multiplier: 1.5
      noise_multiplier: 0.8
      allowed_types: ['inertial_profiler', 'photogrammetry']

# ----------------------------------------------------------------------------
# ğŸ”¥ Decision Model
# ----------------------------------------------------------------------------
decision:
  # ğŸ”¥ P0-3ï¼šç¦ç”¨åˆ†ä½æ•°å…œåº•ï¼ˆç»Ÿä¸€é˜ˆå€¼æ¥æºï¼‰
  tau_quantile: 0.88       # âœ… è®¾ä¸ºnullï¼Œç”± lock_decision_threshold() è®¾ç½® tau_iri
  tau_iri: null            # è¿è¡Œæ—¶è®¾ç½®

  # æˆæœ¬å‚æ•°ï¼ˆ10:1ä¸å¯¹ç§°ï¼‰
  L_FP_gbp: 3000
  L_FN_gbp: 30000
  L_TP_gbp: 400
  L_TN_gbp: 0

  # ğŸ”¥ å†³ç­–éš¾åº¦æ§åˆ¶
  target_ddi: null        # âœ… ä»0.25æ”¹ä¸º0.30ï¼ˆé¿å…ä»£ç ä¸‹é™ï¼‰
  K_action: 12

# ----------------------------------------------------------------------------
# ğŸ”¥ P1-4ï¼šEconomicsï¼ˆç»æµå°ºåº¦æ ¡å‡†ï¼‰
# ----------------------------------------------------------------------------
economics:
  network_km: 200          # ä¸šåŠ¡ç½‘ç»œæ€»é•¿åº¦ï¼ˆå…¬é‡Œï¼‰
  test_km: 35              # å•æ¬¡foldæµ‹è¯•åŸŸè¦†ç›–é•¿åº¦ï¼ˆå…¬é‡Œï¼‰
  horizon_years: 10        # å†³ç­–è¯„ä¼°æœŸï¼ˆå¹´ï¼‰
  eval_period_days: 7      # å•æ¬¡è¯„ä¼°å‘¨æœŸï¼ˆå¤©ï¼‰

# ğŸ”¥ Metricsé…ç½®
metrics:
  scale_savings_to_domain: true  # âœ… ç¡®ä¿ä½¿ç”¨ domain_scale_factor
  coverage_clip: [0.0, 1.0]

# ----------------------------------------------------------------------------
# Sensor Selection Methods
# ----------------------------------------------------------------------------
selection:
  methods:
    - greedy_evi
    - greedy_mi
    - greedy_aopt
    - maxmin
    - uniform
    - random

  budget_type: "count"
  budgets: [1, 3, 5, 8, 10, 15, 20]

  # Greedy-MI é…ç½®
  greedy_mi:
    batch_size: 64
    adaptive_pruning: true
    prune_threshold: 0.10
    use_cost: true
    keep_fraction: 0.20
    adaptive_keep: true

  # Greedy-Aopt é…ç½®
  greedy_aopt:
    n_probes: 8
    use_cost: true

  # ğŸ”¥ P1-6ï¼šGreedy-EVI é…ç½®ï¼ˆæ›´è‹›åˆ»çš„é¢„ç­›ï¼‰
  greedy_evi:
    n_y_samples: 16        # è’™ç‰¹å¡æ´›æ ·æœ¬æ•°
    use_cost: true
    mi_prescreen: true
    keep_fraction: 0.15    # âœ… ä»nullæ”¹ä¸º0.15ï¼ˆæ›´è‹›åˆ»ï¼‰

    # Fold æ§åˆ¶ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼šæ‰€æœ‰foldéƒ½è¿è¡Œï¼‰
    every_n_folds: 1
    budgets_subset: []
    max_folds: null
    must_budgets: []

  maxmin:
    use_cost: true

# ----------------------------------------------------------------------------
# Expected Value of Information
# ----------------------------------------------------------------------------
evi:
  compute_for: ["greedy_mi", "greedy_evi"]
  method: "monte_carlo"
  monte_carlo_samples: 32

# ----------------------------------------------------------------------------
# Cross-Validation
# ----------------------------------------------------------------------------
cv:
  scheme: "spatial_block"
  k_folds: 5
  buffer_width_multiplier: 1.5
  block_strategy: "kmeans"
  ensure_connected: true
  morans_permutations: 999

# ----------------------------------------------------------------------------
# Uncertainty Quantification
# ----------------------------------------------------------------------------
uq:
  bootstrap_method: "spatial_block"
  bootstrap_samples: 1000
  confidence_level: 0.95
  coverage_percentile: 90
  compute_crps: true

# ----------------------------------------------------------------------------
# Diagnostics
# ----------------------------------------------------------------------------
diagnostics:
  morans_i:
    compute: true
    permutations: 999
    alpha: 0.05

  calibration:
    pit_histogram: true
    coverage_curves: true
    reliability_diagram: true

# ----------------------------------------------------------------------------
# Visualization
# ----------------------------------------------------------------------------
plots:
  save_formats: [png, pdf]
  dpi: 300
  style: "seaborn-v0_8-paper"

  budget_curves:
    metrics: ["rmse", "expected_loss_gbp", "coverage_90"]
    show_confidence: true
    confidence_level: 0.95

  performance_profile:
    tau_values: [1.0, 1.05, 1.1, 1.2, 1.5, 2.0, 3.0]
    use_budget_fold_instances: true

  critical_difference:
    alpha: 0.05
    test: "nemenyi"

  business_metrics:
    enable: true
    baseline_method: "uniform"
    show_savings: true
    show_roi: true
    show_cost_efficiency: true

  effect_size:
    enable: true
    plot_heatmaps: true
    plot_pairwise_table: true
    top_k_comparisons: 20

  critical_region:
    enable: true
    epsilon: 0.2
    plot_heatmap: true

  expert_plots:
    enable_all: true

    marginal_efficiency:
      enable: true
      normalize_by_cost: true
      unit: "gbp_per_test_point"
      split_by_unit: true

    type_composition:
      enable: true
      show_cost_breakdown: true

    mi_voi_correlation:
      enable: true
      methods: ["greedy_mi", "greedy_evi"]
      correlation_mode_disable_prescreen: false

    calibration_plots:
      enable: true

    spatial_diagnostics:
      enable: true
      show_morans_i: true

    sensor_placement_map:
      enable: true
      budgets_to_show: [3, 5, 10, 15]

    roi_curves:
      enable: true
      baseline_method: "uniform"
      show_near_threshold: true

    robustness_heatmap:
      enable: true

    ddi_overlay:
      enable: true
      methods_to_compare: ['greedy_evi', 'greedy_mi']

    time_loss_curves:
      enable: false

# ----------------------------------------------------------------------------
# Acceptance Criteria
# ----------------------------------------------------------------------------
acceptance:
  m1_grid_size: 100
  m1_budgets: [5, 10, 20]
  m1_check_monotonic: true
  m1_check_diminishing: true

  m2_min_improvement_vs_random: 0.15
  m2_confidence_level: 0.95

  m3_small_instance_n: 25
  m3_small_instance_k: 5
  m3_max_suboptimality: 0.10

  m4_morans_alpha: 0.05
  m4_coverage_tolerance: 0.10
  m4_msse_tolerance: 0.25

# ============================================================================
# å‚æ•°æ‰«æé¢„è®¾ï¼ˆå¯é€‰ï¼Œç”¨äºæ•æ„Ÿæ€§åˆ†æï¼‰
# ============================================================================
parameter_scan_presets:
  # å½“å‰ä¿®å¤é…ç½®ï¼ˆéªŒè¯ç”¨ï¼‰
  current_fixed:
    pool_fraction: 0.20
    tau_quantile: null
    L_FN_gbp: 30000
    L_FP_gbp: 3000
    target_ddi: 0.30
    alpha: 1.0e-2
    beta_base: 1.0e-3
    beta_hot: 1.0e-5
    keep_fraction: 0.15

  # é«˜é£é™©åœºæ™¯
  high_stakes:
    target_ddi: 0.35
    L_FN_gbp: 60000
    L_FP_gbp: 3000
    keep_fraction: 0.10
    pool_fraction: 0.15

  # ä½é£é™©åœºæ™¯
  low_stakes:
    target_ddi: 0.15
    L_FN_gbp: 15000
    L_FP_gbp: 3000
    keep_fraction: 0.25
    pool_fraction: 0.30

# ============================================================================
# ğŸ“Š é¢„æœŸå¥åº·æŒ‡æ ‡ï¼ˆä¿®å¤ååº”è¾¾åˆ°ï¼‰
# ============================================================================
#
# âœ… ROI æ›²çº¿ï¼š
#   - ROI(k=1) â‰ˆ -0.3 ~ 0.0
#   - ROI(k=5) > 0.0  â˜…
#   - ROI(k=15) > 0.5
#
# âœ… ç®—æ³•å·®è·ï¼š
#   - Greedy-EVI vs Greedy-MI: Î” â‰ˆ 8-15% @ k=3-5  â˜…
#   - Greedy-EVI vs Random: Î” > 30%
#
# âœ… ä¿¡å·è´¨é‡ï¼š
#   - Coverage(90%) â‰ˆ 0.88-0.92
#   - DDI(Global) â‰ˆ 28-32%  â˜…
#   - Moran's I p-value < 0.01
#
# âœ… Action-limitedï¼š
#   - action_hit_rate ä¸å†æ˜¯å¸¸æ•°  â˜…
#   - precision@K, recall@K åˆç†å˜åŒ–
#
# âœ… Near-thresholdï¼š
#   - savings_near_threshold > 0  â˜…
#   - fraction_near_threshold â‰ˆ 15-30%
#
# ============================================================================

# ä½¿ç”¨è¯´æ˜
# ===========================================================================
# 1. é»˜è®¤è¿è¡Œï¼ˆä½¿ç”¨ä¿®å¤åçš„é…ç½®ï¼‰ï¼š
#    python main.py
#
# 2. å¿«é€ŸéªŒè¯ï¼ˆè°ƒè¯•ç”¨ï¼‰ï¼š
#    python main.py --quick-test
#
# 3. å‚æ•°æ‰«æï¼š
#    python main.py --preset high_stakes
#    python main.py --scan ddi=0.25,0.30,0.35
#
# 4. å®Œæ•´å®éªŒï¼ˆå‘è¡¨ç”¨ï¼‰ï¼š
#    python main.py --parallel --workers 6
# ===========================================================================