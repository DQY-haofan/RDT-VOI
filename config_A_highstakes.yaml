# ============================================================================
# RDT-VoI Configuration - SCENARIO A: HIGH-STAKES
# 场景 A：高风险/近阈值决策 - 凸显 EVI 优势
#
# 核心特征：
#   - 高 DDI (0.20-0.35): 大量像元处于决策临界区
#   - 强不对称代价 (FN:FP = 25:1): 漏检代价远高于误报
#   - 稀疏候选池 (20%): 选点难度大
#   - 行动受限 (K_action=10): 维护预算紧张
#
# 预期结果：EVI 在期望损失、ROI、Top-K 命中率上显著领先 MI
# ============================================================================

experiment:
  name: "rdt_voi_A_highstakes"
  seed: 42
  output_dir: "results/A_highstakes"

# ----------------------------------------------------------------------------
# Numerical Settings
# ----------------------------------------------------------------------------
numerics:
  linear_solver_tol: 1.0e-8
  cholesky_nugget: 1.0e-6
  pcg_max_iter: 500
  logdet_method: "cholmod"

# ----------------------------------------------------------------------------
# Spatial Domain (20x20 网格，总 400 像元)
# ----------------------------------------------------------------------------
geometry:
  mode: "grid2d"
  nx: 20
  ny: 20
  h: 5.0

# ----------------------------------------------------------------------------
# Prior Distribution (GMRF/SPDE) - 保持高方差热点
# ----------------------------------------------------------------------------
prior:
  nu: 1.0
  kappa: 0.12
  sigma2: 0.25
  alpha: 2
  beta: 1.0e-6
  mu_prior_mean: 2.2
  mu_prior_std: 0.3

  # 热点配置（用于空间异质性）
  beta_base: 5.0     # 非热点区域的nugget（低不确定性）
  beta_hot: 1.0e-4   # 热点区域的nugget（高不确定性）

  hotspots:
    - center_m: [25, 75]
      radius_m: 20
    - center_m: [75, 25]
      radius_m: 25
    - center_m: [50, 50]
      radius_m: 15

# ----------------------------------------------------------------------------
# Sensor Pool Configuration - 🔥 稀疏池（20%）
# ----------------------------------------------------------------------------
sensors:
  types:
    - name: smartphone
      noise_std: 0.50
      cost_gbp: 30
      footprint: point

    - name: "basic_point"
      noise_std: 0.12
      cost_gbp: 150
      footprint: "point"

    - name: "laser_profiler"
      noise_std: 0.035
      cost_gbp: 800
      footprint: "point"

    - name: photogrammetry
      noise_std: 0.20
      cost_gbp: 100
      footprint: avg3x3

    - name: "vehicle_avg"
      noise_std: 0.30
      cost_gbp: 100
      footprint: "avg5x5"

    - name: inertial_profiler
      noise_std: 0.12
      cost_gbp: 300
      footprint: avg3x3

  pool_strategy: "grid_subsample"
  pool_fraction: 0.40  # 🔥 稀疏池：仅 80 个候选位置（400×0.2）
  type_mix: [0.15, 0.20, 0.10, 0.20, 0.15, 0.20]

  use_heterogeneous: true
  cost_zones:
    - center_m: [100, 100]
      radius_m: 50
      cost_multiplier: 1.5
      noise_multiplier: 0.8
      allowed_types: ['inertial_profiler', 'photogrammetry']

# ----------------------------------------------------------------------------
# Decision Model - 🔥 高风险参数
# ----------------------------------------------------------------------------
decision:
  tau_iri: null
  tau_quantile: 0.75  # 🔥 高分位阈值，提升 DDI 但避免 100%

  # 代价矩阵
  # 🔥 方案1（推荐）：提高 L_FP，p_T ≈ 0.25
  L_FP_gbp: 30000.0      # 5000 → 30000
  L_FN_gbp: 120000.0     # 保持不变
  L_TP_gbp: 800.0
  L_TN_gbp: 0.0
  # p_T = 30000 / (30000 + 120000 - 800) ≈ 0.20 (20%)

  # 🔥 或方案2：降低 L_FN，p_T ≈ 0.30
  # L_FP_gbp: 25000.0
  # L_FN_gbp: 60000.0
  # L_TP_gbp: 800.0
  # p_T = 25000 / (25000 + 60000 - 800) ≈ 0.30 (30%)

  target_ddi: 0.25  # Scenario A: 0.25-0.35 | Scenario B: 0.10-0.15
  K_action: 10      # Scenario A: 10 | Scenario B: null

metrics:
  scale_savings_to_domain: true  # ✅ 启用域缩放（让测试集损失可比于全域成本）
  coverage_clip: [0.0, 1.0]      # Coverage 裁剪范围
# ----------------------------------------------------------------------------
# Sensor Selection Methods - 🔥 前段预算密集
# ----------------------------------------------------------------------------
selection:
  methods:
    - greedy_evi
    - greedy_mi
    - greedy_aopt
    - maxmin
    - uniform
    - random

  budget_type: "count"
  budgets: [1, 3, 5, 8, 10]  # 🔥 从 [3,5,10,15,20] 改为 [1,3,5,8,10]


  greedy_mi:
    batch_size: 64
    adaptive_pruning: true
    prune_threshold: 0.10
    use_cost: true
    keep_fraction: null  # 🔥 新增: null=自动计算 max(4k, 0.25C)


  greedy_aopt:
    n_probes: 32
    use_cost: true

  greedy_evi:
    n_y_samples: 0
    use_cost: true
    mi_prescreen: true  # 主实验保持true；相关性实验时设false
    keep_fraction: null  # Scenario A: 0.5 | Scenario B: 0.5

    # 🔥 关键修复：禁用fold跳过机制
    every_n_folds: 1       # ✅ 1=运行所有fold（不跳过）
    budgets_subset: []     # ✅ 空列表=运行所有budget
    max_folds: null        # ✅ null=不限制fold数量
    must_budgets: []       # ✅ 不需要特殊处理的budget

  maxmin:
    use_cost: true
# ----------------------------------------------------------------------------
# Expected Value of Information - 🔥 足够样本确保稳定
# ----------------------------------------------------------------------------
evi:
  compute_for: ["greedy_mi", "greedy_evi"]
  method: "monte_carlo"
  monte_carlo_samples: 32  # Scenario A: 32 | Scenario B: 16


# ----------------------------------------------------------------------------
# Cross-Validation
# ----------------------------------------------------------------------------
cv:
  scheme: "spatial_block"
  k_folds: 5  # 🔥 建议至少5折，以获得足够实例数（5×5 budgets = 25）
  buffer_width_multiplier: 1.5
  block_strategy: "kmeans"
  ensure_connected: true
  morans_permutations: 999

# ----------------------------------------------------------------------------
# Uncertainty Quantification
# ----------------------------------------------------------------------------
uq:
  bootstrap_method: "spatial_block"
  bootstrap_samples: 1000
  confidence_level: 0.95
  coverage_percentile: 90
  compute_crps: true

# ----------------------------------------------------------------------------
# Diagnostics
# ----------------------------------------------------------------------------
diagnostics:
  morans_i:
    compute: true
    permutations: 999
    alpha: 0.05

  calibration:
    pit_histogram: true
    coverage_curves: true
    reliability_diagram: true

# ----------------------------------------------------------------------------
# 🔥 Visualization - 突出 EVI 的业务价值优势
# ----------------------------------------------------------------------------
plots:
  save_formats: [png, pdf]
  dpi: 300
  style: "seaborn-v0_8-paper"

  budget_curves:
    metrics: ["rmse", "expected_loss_gbp", "coverage_90"]
    show_confidence: true
    confidence_level: 0.95

  performance_profile:
    tau_values: [1.0, 1.05, 1.1, 1.2, 1.5, 2.0, 3.0]
    use_budget_fold_instances: true

  critical_difference:
    alpha: 0.05
    test: "nemenyi"

  business_metrics:
    enable: true
    baseline_method: "uniform"  # 🔥 固定baseline
    show_savings: true     # Scenario A: true | Scenario B: false
    show_roi: true
    show_cost_efficiency: true

  effect_size:
    enable: true
    plot_heatmaps: true
    plot_pairwise_table: true
    top_k_comparisons: 20

  critical_region:
    enable: true   # Scenario A: true | Scenario B: false
    epsilon: 0.2
    plot_heatmap: true

  expert_plots:
    enable_all: true

    marginal_efficiency:
      enable: true
      normalize_by_cost: true
      unit: "gbp_per_test_point"
      # 🔥 新增：分图显示不同单位
      split_by_unit: true

    type_composition:
      enable: true
      show_cost_breakdown: true

    mi_voi_correlation:
      enable: true
      methods: ["greedy_mi", "greedy_evi"]
      # 🔥 相关性实验：暂时禁用MI预筛选
      correlation_mode_disable_prescreen: false

    calibration_plots:
      enable: true  # 可移到附录

    spatial_diagnostics:
      enable: true
      show_morans_i: true

    sensor_placement_map:
      enable: true
      budgets_to_show: [5, 10, 15, 20]

    roi_curves:
      enable: true
      baseline_method: "uniform"  # 🔥 明确指定baseline
      show_near_threshold: true  # 🔥 新增开关


    robustness_heatmap:
      enable: false  # Scenario A: false | Scenario B: true

    ddi_overlay:
      enable: true   # Scenario A: true | Scenario B: false
      methods_to_compare: ['greedy_evi', 'greedy_mi']

# ----------------------------------------------------------------------------
# Acceptance Criteria
# ----------------------------------------------------------------------------
acceptance:
  m1_grid_size: 100
  m1_budgets: [5, 10, 20]
  m1_check_monotonic: true
  m1_check_diminishing: true

  m2_min_improvement_vs_random: 0.15
  m2_confidence_level: 0.95

  m3_small_instance_n: 25
  m3_small_instance_k: 5
  m3_max_suboptimality: 0.10

  m4_morans_alpha: 0.05
  m4_coverage_tolerance: 0.10
  m4_msse_tolerance: 0.25

# ============================================================================
# 场景 A 预期结果
# ============================================================================
# 1. EVI 期望损失比 MI 低 8-15%（在 n=5-15 段）
# 2. EVI 的 ROI 曲线更陡峭（单位传感器成本的损失降低更大）
# 3. Top-K=10 命中率：EVI 在真正高风险区域的覆盖率更高
# 4. DDI 热图显示：EVI 选点更集中在 τ±0.2 的临界区
# 5. Critical Difference 图：EVI 与 MI 达到统计显著性（p<0.05）
# ============================================================================